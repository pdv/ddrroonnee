<!DOCTYPE html>
<title>drone</title>
<link rel='stylesheet' href='http://www.russellmcc.com/knobjs/knobjs.css'>
<script src="http://www.russellmcc.com/knobjs/knob.min.js"></script>

<div id="container">
</div>

<script>
'use strict'

const actx = new window.AudioContext()

const out = actx.createGain();
out.gain.value = 0.5;
out.connect(actx.destination);

const osc1 = actx.createOscillator()
osc1.type = 'sine'
osc1.frequency.value = 220

const osc2 = actx.createOscillator()
osc2.type = 'sine'
osc2.frequency.value = 11

const osc2gain = actx.createGain()
osc2gain.gain.value = 30

const filter = actx.createBiquadFilter()
filter.type = "peaking"
filter.Q.value = 3
filter.frequency.value = 350

const delay = actx.createDelay(1)
const delayGain = actx.createGain()
delayGain.gain.value = 0.7
delay.connect(delayGain)
delayGain.connect(delay)

const hpf = actx.createBiquadFilter()
filter.type = "highpass"
filter.frequency.value = 200


function makeDistortionCurve(amount) {
    var k = typeof amount === 'number' ? amount : 50,
        n_samples = 44100,
        curve = new Float32Array(n_samples),
        deg = Math.PI / 180,
        i = 0,
        x;
    for ( ; i < n_samples; ++i ) {
        x = i * 2 / n_samples - 1;
        curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
    }
    return curve;
}

const distortion = actx.createWaveShaper();
distortion.curve = makeDistortionCurve(400);
distortion.oversample = '4x';

var bufferSize = 2 * actx.sampleRate,
    noiseBuffer = actx.createBuffer(1, bufferSize, actx.sampleRate),
    output = noiseBuffer.getChannelData(0);
for (var i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
}

const whiteNoise = actx.createBufferSource();
whiteNoise.buffer = noiseBuffer;
whiteNoise.loop = true;
whiteNoise.start(0);
const noiseGain = actx.createGain()
noiseGain.gain.value = 0.2
whiteNoise.connect(noiseGain)
noiseGain.connect(filter)

osc2.connect(osc2gain)
osc2gain.connect(osc1.frequency)

osc1.connect(distortion)
distortion.connect(hpf)
hpf.connect(filter)
distortion.connect(filter)

filter.connect(delay)
filter.connect(out)
delay.connect(out)

osc1.start()
osc2.start()

const knobFns = [
    (x) => out.gain.value = x / 200,
    (x) => osc1.frequency.value = x * 5,
    (x) => osc2.frequency.value = x * 10,
    (x) => osc2gain.gain.value = x * 2,
    (x) => filter.frequency.value = x * 10,
    (x) => delayGain.gain.value = x / 100,
    (x) => delay.delayTime.value = x / 100,
    (x) => distortion.curve = makeDistortionCurve(x * 2),
    (x) => hpf.frequency.value = x * 20,
    (x) => noiseGain.gain.value = x / 500
]

const container = document.getElementById('container')
for (var i = 0; i < 16; i++) {
    const knob = document.createElement('x-knobjs-knob')
    knob.setAttribute('id', 'knob' + i)
    knob.value = 20
    const knobFn = knobFns[i]
    knob.onchange = () => knobFn(knob.value)
    container.appendChild(knob);
}

</script>

<style>

#container {
    width: 800px;
    height: 800px;
    position: absolute;
    left: 50%;
    top: 50%;
    margin: -400px 0 0 -400px;
}

x-knobjs-knob {
    width: 150px;
    height: 150px;
    float: left;
    padding: 24px;
}

.knobjs-arc {
     fill: #222;
}

.knobjs-arcbg {
     stroke: #fff;
}

</style>
